name: InstagramæŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      calendar_days:
        description: 'ç”Ÿæˆã™ã‚‹æŠ•ç¨¿æ—¥æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30æ—¥ï¼‰'
        required: false
        type: number
        default: 30
      generate_images:
        description: 'ç”»åƒã‚‚è‡ªå‹•ç”Ÿæˆã™ã‚‹ï¼ˆGemini APIä½¿ç”¨ï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  generate-content:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: WorkFlow_origin

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'WorkFlow_origin/package.json'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-mplus
          echo "ğŸ“ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ•ã‚©ãƒ³ãƒˆä¸€è¦§:"
          fc-list | grep -i "noto\|mplus" | head -20

      # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
      - name: å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p output/images

      # ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è§£æ
      - name: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è§£æ
        run: npm run analyze-homepage

      # æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
      - name: æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CALENDAR_DAYS: ${{ github.event.inputs.calendar_days || '1' }}
        run: npm run generate-calendar

      # ç”»åƒè‡ªå‹•ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆ
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: npm run generate-images

      # ç”»åƒåˆæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ç”»åƒã«ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæˆã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        run: npm run compose-images

      # ç”Ÿæˆç‰©ã‚’Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå€‹åˆ¥ã«åˆ†ã‘ã¦é¸æŠå¯èƒ½ã«ï¼‰
      - name: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: calendar-csv
          path: WorkFlow_origin/output/calendar.csv
          retention-days: 90

      - name: ãƒ“ã‚¸ãƒã‚¹ã‚µãƒãƒªãƒ¼ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: business-summary
          path: WorkFlow_origin/output/business-summary.txt
          retention-days: 90

      - name: AIç”Ÿæˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: ai-generated-images
          path: WorkFlow_origin/output/images/
          retention-days: 90

      - name: åˆæˆæ¸ˆã¿ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: composed-images
          path: WorkFlow_origin/output/composed/
          retention-days: 90

      - name: ä¸€æ‹¬æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿.CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        uses: actions/upload-artifact@v4
        with:
          name: bulk-post-csv
          path: WorkFlow_origin/output/ä¸€æ‹¬æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿.csv
          retention-days: 90

      # çµæœã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: success()
        working-directory: .
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [[ -n $(git status -s WorkFlow_origin/output/) ]]; then
            git add WorkFlow_origin/output/
            git commit -m "ğŸ¤– è‡ªå‹•ç”Ÿæˆ: InstagramæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ $(date '+%Y-%m-%d')"
            git push
          else
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

      # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: å®Œäº†
        run: |
          echo "âœ… InstagramæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆå®Œäº†"
          echo ""
          echo "ğŸ“¦ ä»¥ä¸‹ã®Artifactã‹ã‚‰å¿…è¦ãªã‚‚ã®ã‚’é¸æŠã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™:"
          echo "   1ï¸âƒ£ calendar-csv - æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆCSVå½¢å¼ï¼‰"
          echo "   2ï¸âƒ£ business-summary - ãƒ“ã‚¸ãƒã‚¹ã‚µãƒãƒªãƒ¼"
          if [ "${{ github.event.inputs.generate_images }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
            echo "   3ï¸âƒ£ ai-generated-images - AIç”Ÿæˆç”»åƒï¼ˆå…ƒç”»åƒï¼‰"
            echo "   4ï¸âƒ£ composed-images - åˆæˆæ¸ˆã¿ç”»åƒï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥ã‚Šã€3:4ã‚µã‚¤ã‚ºï¼‰"
            echo "   5ï¸âƒ£ bulk-post-csv - ä¸€æ‹¬æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿.CSVï¼ˆInstagramäºˆç´„æŠ•ç¨¿ç”¨ï¼‰"
            echo ""
            echo "ğŸŒ åˆæˆæ¸ˆã¿ç”»åƒã¯ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™:"
            echo "   https://images.if-juku.net/juku_post_$(date '+%Y_%m')/"
          fi
          echo ""
          echo "ğŸ’¡ å„Artifactã¯å€‹åˆ¥ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ï¼ˆzipãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ï¼‰"
