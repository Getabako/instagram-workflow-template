name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è‡ªå‹•ç”Ÿæˆ

on:
  # æ‰‹å‹•å®Ÿè¡Œã®ã¿
  workflow_dispatch:
    inputs:
      custom_prompt:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä»»æ„ï¼‰: CSVå†…å®¹ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã®è¿½åŠ æŒ‡ç¤º'
        required: false
        type: string
        default: ''

jobs:
  generate-character:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    defaults:
      run:
        working-directory: WorkFlow_origin

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'WorkFlow_origin/package.json'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼CSVç”Ÿæˆ
      - name: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼CSVã‚’ç”Ÿæˆ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CUSTOM_PROMPT: ${{ github.event.inputs.custom_prompt }}
        run: npm run generate-character-csv

      # ç”Ÿæˆã•ã‚ŒãŸCSVã‚’Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ç”Ÿæˆã•ã‚ŒãŸCSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: character-csvs
          path: WorkFlow_origin/character/*/*.csv
          retention-days: 90

      # çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
      - name: çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: success()
        working-directory: .
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [[ -n $(git status -s WorkFlow_origin/character/) ]]; then
            git add WorkFlow_origin/character/
            git commit -m "ğŸ¤– è‡ªå‹•ç”Ÿæˆ: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼CSV $(date '+%Y-%m-%d')"
            git push
          else
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

      # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: å®Œäº†
        run: |
          echo "âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼CSVç”Ÿæˆå®Œäº†"
          echo ""
          echo "ğŸ“¦ Artifactã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½:"
          echo "   character-csvs - ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼CSVãƒ•ã‚¡ã‚¤ãƒ«"
